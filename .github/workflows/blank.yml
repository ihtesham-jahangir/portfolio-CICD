name: ğŸš€ Build & Deploy Next.js to Azure Web App

on:
  push:
    branches: [ main ]

env:
  REGISTRY: nextjs2f5aa50a.azurecr.io
  IMAGE: nextjs-app
  WEBAPP_NAME: nextjs-web-b48035
  RESOURCE_GROUP: nextjs-rg

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ”‘ Login to ACR
      uses: azure/docker-login@v2
      with:
        login-server: ${{ env.REGISTRY }}
        username:     ${{ secrets.ACR_USERNAME }}
        password:     ${{ secrets.ACR_PASSWORD }}

    - name: ğŸ› ï¸ Build and Push Docker image
      run: |
        docker build -t $REGISTRY/$IMAGE:${{ github.sha }} .
        docker push    $REGISTRY/$IMAGE:${{ github.sha }}

    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        images: ${{ env.REGISTRY }}/${{ env.IMAGE }}:${{ github.sha }}
